---
title: "Les inégalités de genre dans la profession informatique"
author: "Elise Hodbert, Nolwenn Paquet, Victoria Bancel"
output: 
  flexdashboard::flex_dashboard:
    theme: flatly
    orientation: columns
    vertical_layout: fill
    navbar:
      - { title: "Lien", href: "https://www.asdcode.de/2020/01/it-salary-survey-december-2019.html", align: left }
params:
  setup_path: ../resources/
---

<style>                     
.navbar {
  background-color:#005D67;
  border-color:#64A79A;
}
.navbar-brand {
color:black!important;
}


</style>   


```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(ggplot2)
library(plotly)
library(ggplot2)
library("rnaturalearth")
library("rnaturalearthdata")
library(tidyverse)
library(maps)
library(ggrepel)
library(ggpubr)
library(scatterpie)
library(colorspace)
library(tidyr)
library(dplyr)
library(plyr)
library(scales)
library(grid)
library(ggfun)

#importation des données
data2019 <- read.csv("archive/T Salary Survey EU 2019.csv", 
                     header = TRUE, 
                     sep = ";", 
                     encoding = "latin1")
data2019$City <- as.factor(data2019$City)
data2019$Gender <- as.factor(data2019$Gender)

library(stringr)
data2019$City = str_replace_all(data2019$City, pattern = "Braunschweig", replacement = "Brunswick")
data2019$City = str_replace_all(data2019$City, pattern = "DÃ¼sseldorf", replacement = "Dusseldorf")
data2019$City = str_replace_all(data2019$City, pattern = "Hannover", replacement = "Hanover")
data2019$City = str_replace_all(data2019$City, pattern = "Kassel ", replacement = "Kassel")
data2019$City = str_replace_all(data2019$City, pattern = "Marburg", replacement = "Magdeburg")
data2019$City = str_replace_all(data2019$City, pattern = "WÃ¼rzburg ", replacement = "Wurzburg")

villes= c("Berlin", "Bielefeld", "Brunswick", "Bremen", "Cologne", "Dusseldorf",
               "Darmstadt","Dresden", "Frankfurt", "Freiburg", "Hamburg",
               "Hanover", "Heidelberg","Ingolstadt", "Kaiserslautern",
               "Karlsruhe", "Kassel", "Koblenz", "Leipzig", "Lingen",
               "Magdeburg", "Munich", "Nuremberg", "Pforzheim", "Stuttgart", 
               "Wurzburg","Walldorf", "Wolfsburg")

data2019_Allemagne <- subset(data2019, City %in% villes) # on conserve seulement les villes en allemagne

dta <- subset(data2019_Allemagne, select=c("Age","Gender","City",
                                           "Seniority.level",
                                           "Position..without.seniority.",
                                           "Years.of.experience",
                                 "Yearly.brutto.salary..without.bonus.and.stocks."))
# on conserve seulement les variables d'interêt

colnames(dta) <- c("Age", "Gender", "City",
                   "Seniority_level",
                   "Position",
                   "Years_of_experience",
                   "Yearly_salary")





```


Présentation de l'étude
=======================================================================

Row
-----------------------------------------------------------------------


### Présentation des données (après prétraitement)



```{r}
summary(dta)
```


Row
-----------------------------------------------------------------------

### Présentation de l'étude

L'étude provient d'une enquête menée auprès de personnes travaillant dans le domaine de l'IT. Cette enquête a été menée en Allemagne, en 2019. 826 personnes y ont participé, dont 129 femmes et 687 hommes.

Dans notre exposé, nous nous interessons plus particuilièrement aux ingéalités qui existent entre les hommes et les femmmes, dans ce domaine de l'IT. Nous nous intéressons plus particuilièrement à trois inégalités : nombre de postes pourvus, salaires et positions au sein de l'entreprise.


Nombre de postes pourvus
=======================================================================

```{r  ggplotly, echo = FALSE,  eval = TRUE,  message = FALSE, warning=FALSE}
dta$City = as.factor(dta$City)

Germany <- map_data("world") %>% filter(region == "Germany")
Cities <- world.cities %>% filter(country.etc == "Germany")
Cities_allemagne <- Cities %>% filter(name %in% villes)
Cities_allemagne <- Cities_allemagne[-10,]

female = data.frame(table(dta$City[dta$Gender == "Female"]))
male = data.frame(table(dta$City[dta$Gender == "Male"]))
sum = female$Freq + male$Freq
dta_graph = data.frame(Cities_allemagne, Femme = female$Freq, Homme = male$Freq, sum = sum)
carte = ggplot() + 
  geom_polygon(data = Germany, aes(x = long, y = lat, group = group), 
               fill="grey",color="black", alpha = 0.4)+
  geom_scatterpie(data = dta_graph, 
                aes(x = long, y = lat,group = name, r = log(sum)/8),
                alpha =.5, cols = c("Femme","Homme"), color = "black")+
                scale_fill_manual(name = "Genre", values = c('#645A9F','#005D67'))+
  geom_scatterpie_legend(radius = log(dta_graph$sum)/8, x = 4, y = 47.5, 
                         labeller = function(x) round(exp(x*8), 0))+
  geom_text_repel(data = dta_graph, aes(x = long, y = lat, label = name), size = 3,   col = "black", family = "sans")+
  geom_point(data=dta_graph, aes(x = long, y = lat), color = "black", size = 1)+
  theme_void()+ 
  labs(title = "Repartition géographique des postes des participants de l'enquête",
     caption = "Source : Viktor Shcherban and Ksenia Legostay")+
  theme(
    plot.title = element_text(color = "black", size = 12, hjust = 0.5),
    plot.caption = element_text(color = "black", face = "italic", hjust = 1)
  )
carte
```



Salaires
=======================================================================
```{r, include = FALSE,}
dta$Position[242] = "NA" # la personne 242 n'a pas renseigné son job
dta$Position = as.factor(dta$Position)

a <- as.data.frame(summary(dta$Position))
colnames(a) <- "count"
a$count = as.numeric(a$count)

nvelles_positions = c()
for (i in 1:nrow(a)){
  if (a[i,1] < 10){
    nvelles_positions = c(nvelles_positions,"Other professions")
  }
  else if(a[i,1] %in% c("Data Scientist","Data Analyst","Data Engineer")){
    nvelles_positions=c(nvelles_positions,"Data Scientist")
  }
  else{
    nvelles_positions=c(nvelles_positions,rownames(a)[i])
  }
}

b <- data.frame(rownames(a),nvelles_positions)

# Création d'une nouvelle colonne dans dta contenant les nouveaux noms des jobs

Position2 = c()
for (i in 1:nrow(dta)){
  Position2=c(Position2,b[which(b[,1] == dta$Position[i]),2])
}

dta <- data.frame(dta,Position2)

####### Graph 1

# On crée un jeu de données contenant le nombre de personnes par position et par genre

positions_femmes = sapply(unique(nvelles_positions),function(i){
  dta_femmes = subset(dta,Gender == "Female")
  return(length(which(dta_femmes$Position2 == i)))
})

positions_hommes = sapply(unique(nvelles_positions),function(i){
  dta_hommes = subset(dta,Gender == "Male")
  return(length(which(dta_hommes$Position2 == i)))
})

salaries_femmes = sapply(unique(nvelles_positions),function(i){
  dta_femmes = subset(dta,Gender == "Female")
  return(mean(dta_femmes$Yearly_salary[which(dta_femmes$Position2 == i)],na.rm=T))
})

salaries_hommes = sapply(unique(nvelles_positions),function(i){
  dta_hommes = subset(dta,Gender == "Male")
  return(mean(dta_hommes$Yearly_salary[which(dta_hommes$Position2 == i)],na.rm=T))
})


dta_graph1<- rbind(data.frame("Position" = unique(nvelles_positions),
                              "Gender" = c("Female"),
                              "Count" = positions_femmes,
                              "Salaries" = salaries_femmes),
                   data.frame("Position" = unique(nvelles_positions),
                              "Gender" = c("Male"),
                              "Count" = positions_hommes,
                              "Salaries" = salaries_hommes))

dta_graph1$Position2 <- ifelse(dta_graph1$Gender == "Male",
                               -1*dta_graph1$Count,
                               dta_graph1$Count)


difference_salaire <- sapply(unique(nvelles_positions),function(i){
  dta_hommes = subset(dta, Gender == "Male" & Position2 == i)
  dta_femmes = subset(dta, Gender == "Female" & Position2 == i)
  #diff <- dta_hommes$Yearly_salary[which(dta_hommes$Position2 == i)] - dta_femmes$Yearly_salary[which(dta_hommes$Position2 == i)]
  diff <- mean(dta_hommes$Yearly_salary, na.rm = TRUE) - mean(dta_femmes$Yearly_salary, na.rm = TRUE)
  return(diff)
})

dta_difference <- data.frame(cbind(unique(nvelles_positions)), round_any(difference_salaire, 500))
colnames(dta_difference)[2] <- "difference_salaire"
colnames(dta_difference)[1] <- "Position"
dta_difference <- dta_difference[-which(dta_difference$Position == "DevOps"),] 
dta_difference$Position[which(dta_difference$Position == "QA")] <- "Quality Assurance"
#on enlève la ligne du métier correspondant à DevOps car pas de données pour les femmes

# salaire moyen des hommes et des femmes pour tous métiers confondus
salaire_moy_hommes_femmes <- sapply(unique(dta$Gender), function(i){
  dta_genre = subset(dta, Gender == i)
  moy_genre <- mean(dta_genre$Yearly_salary, na.rm = TRUE) 
  return(moy_genre)
})



#on arrondi les salaires aux 5000 euros près
dta_graph1$Salaries <- round_any(dta_graph1$Salaries, 5000)
format(dta_graph1$Salaries, scientific = TRUE, )

```


```{r, echo = FALSE, eval = TRUE,  message = FALSE, warning=FALSE, fig.width= 15, fig.height = 12}
ggplot(dta_difference, aes(x = reorder(Position, difference_salaire),y = difference_salaire, fill = )) +
  geom_bar(aes(fill = 'Surplus salarial gagné\npar les hommes (en milliers d\'euros)'), 
           stat = "identity",
           position = "identity") +
  scale_y_continuous(labels = label_number(scale = 1e-3, suffix = "K", accuracy = 1), breaks = seq(0, 50000, 5000)) +
  ylab("") +
  labs(fill = "Légende", title = "Différence salariale annuelle entre les hommes et les femmes\n selon les différents métiers de l'IT") +
  scale_fill_manual(values = c('#005D67')) +
  geom_hline(yintercept = salaire_moy_hommes_femmes[1] - salaire_moy_hommes_femmes[2] + 500, color = 'red', linewidth = 1) +
  geom_text( x = 4, y = salaire_moy_hommes_femmes[1] - salaire_moy_hommes_femmes[2], vjust = -1, color = "red",size = 4.5, label = "Différence de salaire moyen entre les hommes et les femmes") +
  geom_text(aes(x = Position, y = difference_salaire, label = paste0(difference_salaire * 1e-3, "K")), family = "sans", color = "white", fontface = "bold", cex = 4.5, vjust = 1.4) +
  annotation_custom(grob = linesGrob(), xmin = 2.6, xmax = 2.75, ymin = 80, ymax = 80) +
  theme(panel.background = element_rect(fill= "white", colour = "white"),
        axis.line.y = element_line(linewidth = 1),
        axis.title.x = element_blank(),
        axis.title.y = element_text(family = "sans", size = 20, vjust = -3),
        axis.text.x = element_text(angle= 60,family="sans",size=12, vjust = 1, hjust = 1, face = "bold", color = "black"), 
        axis.text.y = element_text(family="sans",size=13, hjust = 1, margin = margin(40, 40, 40, 40), face = "bold", color = "black"),
        axis.ticks=element_blank(),
        legend.text = element_text(family = "sans", size = 13),
        legend.title = element_text(family = "sans", size = 15, vjust = 1.5, face = "bold"),
        legend.title.align = 0.3,
        legend.margin = margin(0,1,0,0, "cm"),
        legend.position = c(0.6,0.8),
        plot.margin = margin(2,2,0.5,0.3, "cm"),
        plot.title = element_text(hjust = 0.5, vjust = 6, family = "sans", color = "black", face = "bold", size = 25),
        plot.subtitle = element_text(hjust = 0.5, vjust = 6, family = "sans", color = "black", size = 15))

```


Positions au sein de l'entreprise
=======================================================================
```{r, include = FALSE}
dta_graph1_female <- dta_graph1[which(dta_graph1$Gender == "Female"),]
tot_moy_female <- c()
for (position in dta_graph1_female$Position2){
  #moy <- c(dta$Yearly_salary[(which(dta$Gender == 'Female') %in% which(dta$Position2 == position))])
  moy <- subset(dta,Gender=="Female" & Position2 == position)$Yearly_salary
  moy <- mean(moy, na.rm = TRUE)
  tot_moy_female <- c(tot_moy_female, moy)
}

dta_graph1_male <- dta_graph1[which(dta_graph1$Gender == "Male"),]
tot_moy_male <- c()
for (position in dta_graph1_male$Position){
  moy <- c(dta$Yearly_salary[(which(dta$Gender == 'Male') %in% (which(dta$Position2 == position)))])
  moy <- mean(moy, na.rm = TRUE)
  tot_moy_male <- c(tot_moy_male, moy)
}

```


```{r}

```

